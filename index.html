<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK via CDN -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getDatabase, ref, get, set, update, push, child } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // üîê Your Firebase config (replace if different)
        const firebaseConfig = {
            apiKey: "AIzaSyBpzCla5s18uNBAU6T39jFy60ECULYcPoc",
            authDomain: "studentportal-d48b3.firebaseapp.com",
            databaseURL: "https://studentportal-d48b3-default-rtdb.firebaseio.com",
            projectId: "studentportal-d48b3",
            storageBucket: "studentportal-d48b3.firebasestorage.app",
            messagingSenderId: "819003837531",
            appId: "1:819003837531:web:f1b915b2a1a6193856437e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Make available globally
        window.firebaseInitialized = true;
        window.db = db;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebasePush = push;

        console.log("‚úÖ Firebase initialized");
    </script>

    <style>
        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .gradient-bg { background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #0f172a 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); }
        .glass-effect { background: rgba(31,41,55,0.8); backdrop-filter: blur(10px); border: 1px solid rgba(75,85,99,0.3); }
        .dark-card { background: linear-gradient(145deg, #374151, #1f2937); border: 1px solid #4b5563; }
        .attendance-present { background: linear-gradient(135deg, #059669, #047857); }
        .attendance-absent { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .attendance-neutral { background: linear-gradient(135deg, #6b7280, #4b5563); }
    </style>
</head>
<body class="gradient-bg min-h-screen">

<!-- Login Page -->
<div id="authPage" class="min-h-screen flex items-center justify-center p-4">
    <div class="glass-effect rounded-3xl shadow-2xl p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border border-gray-600">
                <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Student Portal</h1>
            <p class="text-gray-300">Admin-Controlled System</p>
        </div>
        <div class="mb-4">
            <div class="flex bg-gray-700/50 rounded-xl p-1">
                <button id="studentTypeTab" class="flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all text-gray-300 hover:text-white">Student</button>
                <button id="adminTypeTab" class="flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all bg-green-600 text-white shadow-md">Admin</button>
            </div>
        </div>
        <form id="loginForm" class="space-y-4">
            <div id="rollNoField" class="hidden">
                <label class="block text-sm font-medium text-gray-300 mb-2">Roll Number</label>
                <input type="text" id="rollNo" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white placeholder-gray-400" placeholder="Enter roll number">
            </div>
            <div id="usernameField">
                <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                <input type="text" id="username" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white placeholder-gray-400" placeholder="Enter username">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                <input type="password" id="password" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white placeholder-gray-400" placeholder="Enter password">
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-xl font-medium hover:from-green-700 hover:to-green-800 transition-colors shadow-lg">Login</button>
        </form>
        <div id="authError" class="mt-4 p-3 bg-red-900/50 border border-red-700 text-red-300 rounded-xl hidden"></div>
    </div>
</div>

<!-- Student Dashboard -->
<div id="studentDashboard" class="hidden min-h-screen bg-gray-900">
    <nav class="bg-gray-800 shadow-xl border-b-2 border-green-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-white">Student Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="studentName" class="text-gray-300 font-medium"></span>
                    <button onclick="logout()" class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-2 rounded-xl hover:from-red-700 hover:to-red-800 transition-all shadow-lg">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto p-6">
        <div id="studentResults" class="fade-in"></div>
        <div id="studentAttendance" class="fade-in hidden"></div>
    </div>
</div>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="hidden min-h-screen bg-gray-900">
    <nav class="bg-gray-800 shadow-xl border-b-2 border-green-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-white">Admin Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex space-x-2">
                        <button id="studentsTabBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">Students</button>
                        <button id="attendanceTabBtn" class="px-4 py-2 bg-gray-700 text-gray-300 rounded-lg font-medium hover:bg-gray-600">Attendance</button>
                        <button id="notificationsTabBtn" class="px-4 py-2 bg-gray-700 text-gray-300 rounded-lg font-medium hover:bg-gray-600">Notifications</button>
                    </div>
                    <button id="addStudentBtn" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-xl hover:from-green-700 hover:to-green-800 transition-all shadow-lg">Add Student</button>
                    <button onclick="logout()" class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-2 rounded-xl hover:from-red-700 hover:to-red-800 transition-all shadow-lg">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto p-6">
        <!-- Students Tab -->
        <div id="studentsTab">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                <div class="dark-card p-6 rounded-2xl shadow-xl text-white card-hover cursor-pointer" onclick="showAllStudents()">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-300">Total Students</h3>
                            <p id="totalStudents" class="text-4xl font-bold text-green-400">0</p>
                        </div>
                        <div class="w-16 h-16 bg-green-600/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="dark-card p-6 rounded-2xl shadow-xl text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-300">Pass Rate</h3>
                            <p id="passRate" class="text-4xl font-bold text-green-400">0%</p>
                        </div>
                        <div class="w-16 h-16 bg-green-600/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="dark-card p-6 rounded-2xl shadow-xl text-white card-hover cursor-pointer" onclick="showBacklogStudents()">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-300">Backlogs</h3>
                            <p id="backlogCount" class="text-4xl font-bold text-red-400">0</p>
                        </div>
                        <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="dark-card p-6 rounded-2xl shadow-xl text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-300">Low Attendance</h3>
                            <p id="lowAttendanceCount" class="text-4xl font-bold text-yellow-400">0</p>
                        </div>
                        <div class="w-16 h-16 bg-yellow-600/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div id="studentsListSection" class="dark-card rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6">All Students</h2>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                        <tr class="bg-gray-700/50">
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Roll No</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Name</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">CGPA</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Attendance</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Backlogs</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="backlogDetailsSection" class="hidden dark-card rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Students with Backlogs</h2>
                    <button onclick="showAllStudents()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">Back to All Students</button>
                </div>
                <div id="backlogStudentsList"><!-- Filled by JS --></div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendanceTab" class="hidden">
            <div class="dark-card rounded-2xl shadow-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-white mb-6">Daily Attendance</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Date</label>
                        <input type="date" id="attendanceDate" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Program</label>
                        <select id="attendanceProgram" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white">
                            <option value="">Select Program</option>
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                            <option value="B.E">B.E</option>
                            <option value="M.E">M.E</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Course</label>
                        <select id="attendanceCourse" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white">
                            <option value="">Select Course</option>
                            <option value="Computer Science Engineering">Computer Science Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electronics and Communication">Electronics and Communication</option>
                            <option value="Electrical Engineering">Electrical Engineering</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Semester</label>
                        <select id="attendanceSemester" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white">
                            <option value="">Select Semester</option>
                            <option value="1">1</option><option value="2">2</option>
                            <option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Subject</label>
                        <select id="attendanceSubject" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                </div>
                <button onclick="loadAttendanceStudents()" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-green-800 transition-all shadow-lg">Load Students</button>
            </div>
            <div id="attendanceStudentsList" class="dark-card rounded-2xl shadow-xl p-6">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notificationsTab" class="hidden">
            <div class="dark-card rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6">Parent Notification Logs</h2>
                <div class="space-y-4" id="notificationsList">
                    <div class="text-gray-400">Notifications sent to parents will appear here.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Student Modal -->
<div id="studentModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="dark-card rounded-2xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modalTitle" class="text-3xl font-bold text-white">Add Student</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
        </div>
        <form id="studentForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Roll Number</label>
                    <input type="text" id="modalRollNo" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Student Name</label>
                    <input type="text" id="modalStudentName" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Password</label>
                    <input type="password" id="modalPassword" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Parent's Phone Number</label>
                    <input type="tel" id="modalParentPhone" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" placeholder="+91 9876543210" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Program</label>
                    <select id="modalProgram" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                        <option value="">Select Program</option>
                        <option value="B.Tech">B.Tech</option>
                        <option value="M.Tech">M.Tech</option>
                        <option value="B.E">B.E</option>
                        <option value="M.E">M.E</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Course</label>
                    <select id="modalCourse" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                        <option value="">Select Course</option>
                        <option value="Computer Science Engineering">Computer Science Engineering</option>
                        <option value="Information Technology">Information Technology</option>
                        <option value="Electronics and Communication">Electronics and Communication</option>
                        <option value="Electrical Engineering">Electrical Engineering</option>
                        <option value="Mechanical Engineering">Mechanical Engineering</option>
                        <option value="Civil Engineering">Civil Engineering</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Current Semester</label>
                    <select id="modalSemester" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                        <option value="">Select Semester</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                        <option value="4">Semester 4</option>
                        <option value="5">Semester 5</option>
                        <option value="6">Semester 6</option>
                        <option value="7">Semester 7</option>
                        <option value="8">Semester 8</option>
                    </select>
                </div>
            </div>
            <div id="semesterResults">
                <!-- Dynamically added -->
            </div>
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-600">
                <button type="button" onclick="closeModal()" class="px-8 py-3 border border-gray-600 rounded-xl text-gray-300 hover:bg-gray-700 transition-colors font-medium">Cancel</button>
                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all shadow-lg font-medium">Save Student</button>
            </div>
        </form>
    </div>
</div>

<script>
// Global variables
let students = [];
let admins = [{ username: "admin", password: "admin123", name: "System Admin" }];
let currentUser = null;
let isAdmin = false;
let editingStudent = null;
let notifications = [];

// Curriculum templates
const curriculumTemplates = {
    "B.Tech": {
        "Computer Science Engineering": {
            1: ["Mathematics I", "Physics", "Chemistry", "Programming Fundamentals", "English Communication"],
            2: ["Mathematics II", "Data Structures", "Digital Logic Design", "Electronics", "Environmental Science"],
            3: ["Database Management Systems", "Computer Networks", "Operating Systems", "Software Engineering", "Discrete Mathematics"],
            4: ["Web Development", "Machine Learning", "Compiler Design", "Algorithm Analysis", "Computer Graphics"]
        },
        "Electronics and Communication": {
            1: ["Mathematics I", "Physics", "Chemistry", "Basic Electronics", "Engineering Drawing"],
            2: ["Circuit Analysis", "Electronic Devices", "Digital Electronics", "Materials Science", "Engineering Mechanics"]
        }
    }
};

// Wait for Firebase
async function waitForFirebase() {
    return new Promise((resolve) => {
        const check = () => {
            if (window.firebaseInitialized) resolve();
            else setTimeout(check, 100);
        };
        check();
    });
}

// Load students from Firebase
async function loadStudentsFromFirebase() {
    await waitForFirebase();
    try {
        const snapshot = await window.firebaseGet(window.firebaseRef(window.db, 'students'));
        if (snapshot.exists()) {
            const data = snapshot.val();
            students = Object.keys(data).map(key => ({
                ...data[key],
                id: key
            }));
        }
        updateAdminStats();
        displayAllStudents();
        checkAndSendNotifications(); // Check after load
    } catch (error) {
        console.error("Failed to load:", error);
    }
}

// Save all students to Firebase
async function syncToFirebase() {
    await waitForFirebase();
    const obj = {};
    students.forEach(s => obj[s.rollNo] = s);
    await window.firebaseSet(window.firebaseRef(window.db, 'students'), obj);
    console.log("üíæ Synced to Firebase!");
}

// Grade helpers
function calculateGrade(marks) {
    return marks >= 90 ? 'A+' : marks >= 80 ? 'A' : marks >= 70 ? 'B+' : marks >= 60 ? 'B' : marks >= 50 ? 'C+' : marks >= 40 ? 'C' : 'F';
}
function getGradePoints(marks) { return marks >= 90 ? 10 : marks >= 80 ? 9 : marks >= 70 ? 8 : marks >= 60 ? 7 : marks >= 50 ? 6 : marks >= 40 ? 5 : 0; }
function calculateSPI(sem) {
    const total = sem.subjects.reduce((sum, s) => sum + getGradePoints(s.marks), 0);
    return sem.subjects.length > 0 ? (total / sem.subjects.length).toFixed(2) : 0;
}
function calculateCGPA(student) {
    let totalGP = 0, totalSubs = 0;
    Object.values(student.semesters || {}).forEach(sem => {
        sem.subjects.forEach(s => {
            totalGP += getGradePoints(s.marks);
            totalSubs++;
        });
    });
    return totalSubs > 0 ? (totalGP / totalSubs).toFixed(2) : 0;
}
function calculateBacklogs(student) {
    const list = [];
    Object.entries(student.semesters || {}).forEach(([sem, data]) => {
        data.subjects.forEach(s => {
            if (s.marks < 40) list.push({ semester: sem, subject: s.name, marks: s.marks });
        });
    });
    return list;
}
function calculateAttendancePercentage(student) {
    let total = 0, present = 0;
    Object.values(student.attendance || {}).forEach(dates => {
        Object.values(dates).forEach(status => {
            total++;
            if (status === 'present') present++;
        });
    });
    return total ? Math.round((present / total) * 100) : 100;
}

// Send notification ‚Üí triggers Twilio SMS via Firebase Function
async function sendNotification(student, type, data) {
    const msg = type === 'low_attendance'
        ? `Low attendance: ${data.percentage}%`
        : `${data.count} backlog(s): ${data.subjects}`;

    await window.firebasePush(window.firebaseRef(window.db, 'notifications'), {
        studentName: student.name,
        rollNo: student.rollNo,
        toPhone: student.parentPhone.replace(/\D/g, ''), // Clean phone number
        message: `Dear Parent, ${student.name}: ${msg}.`,
        timestamp: Date.now(),
        status: 'queued'
    });
}

// Check and send alerts
async function checkAndSendNotifications() {
    students.forEach(student => {
        const attPercent = calculateAttendancePercentage(student);
        const backlogs = calculateBacklogs(student);

        if (attPercent < 70) {
            sendNotification(student, 'low_attendance', { percentage: attPercent });
        }
        if (backlogs.length > 0) {
            sendNotification(student, 'backlog', {
                count: backlogs.length,
                subjects: backlogs.map(b => b.subject).join(', ')
            });
        }
    });
}

// Display functions...
document.getElementById('attendanceDate').valueAsDate = new Date();

// Tab switching
document.getElementById('studentTypeTab').addEventListener('click', () => {
    document.getElementById('studentTypeTab').className = 'flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all bg-green-600 text-white shadow-md';
    document.getElementById('adminTypeTab').className = 'flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all text-gray-300 hover:text-white';
    document.getElementById('rollNoField').classList.remove('hidden');
    document.getElementById('usernameField').classList.add('hidden');
});
document.getElementById('adminTypeTab').addEventListener('click', () => {
    document.getElementById('adminTypeTab').className = 'flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all bg-green-600 text-white shadow-md';
    document.getElementById('studentTypeTab').className = 'flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all text-gray-300 hover:text-white';
    document.getElementById('usernameField').classList.remove('hidden');
    document.getElementById('rollNoField').classList.add('hidden');
});

// Admin tabs
document.getElementById('studentsTabBtn').addEventListener('click', () => switchAdminTab('students'));
document.getElementById('attendanceTabBtn').addEventListener('click', () => switchAdminTab('attendance'));
document.getElementById('notificationsTabBtn').addEventListener('click', () => switchAdminTab('notifications'));

function switchAdminTab(tab) {
    ['students', 'attendance', 'notifications'].forEach(t => {
        document.getElementById(`${t}Tab`).classList.add('hidden');
        document.getElementById(`${t}TabBtn`).className = 'px-4 py-2 bg-gray-700 text-gray-300 rounded-lg font-medium hover:bg-gray-600';
    });
    document.getElementById(`${tab}Tab`).classList.remove('hidden');
    document.getElementById(`${tab}TabBtn`).className = 'px-4 py-2 bg-green-600 text-white rounded-lg font-medium';
}

// Add student button
document.getElementById('addStudentBtn').addEventListener('click', () => {
    editingStudent = null;
    document.getElementById('modalTitle').textContent = 'Add Student';
    document.getElementById('studentForm').reset();
    generateSemesterInputs(parseInt(document.getElementById('modalSemester').value));
    document.getElementById('studentModal').classList.remove('hidden');
});

// Form submission
document.getElementById('studentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const rollNo = document.getElementById('modalRollNo').value.trim();
    const name = document.getElementById('modalStudentName').value.trim();
    const password = document.getElementById('modalPassword').value;
    const parentPhone = document.getElementById('modalParentPhone').value.trim();
    const program = document.getElementById('modalProgram').value;
    const course = document.getElementById('modalCourse').value;
    const currentSemester = parseInt(document.getElementById('modalSemester').value);

    const semesters = {};
    for (let i = 1; i <= currentSemester; i++) {
        const subjects = Array.from(document.querySelectorAll(`#semester-${i}-subjects .subject-row`)).map(row => ({
            name: row.querySelector('.subject-name').value,
            marks: parseInt(row.querySelector('.subject-marks').value)
        })).filter(s => s.name && !isNaN(s.marks));
        semesters[i] = { subjects };
    }

    const studentData = {
        rollNo, name, password, parentPhone, program, course, currentSemester, semesters,
        attendance: {}
    };

    if (editingStudent) {
        const idx = students.findIndex(s => s.rollNo === editingStudent.rollNo);
        students[idx] = studentData;
    } else {
        students.push(studentData);
    }

    closeModal();
    displayAllStudents();
    updateAdminStats();
    await syncToFirebase();
});

// Generate semester inputs
function generateSemesterInputs(semester, student = null) {
    const container = document.getElementById('semesterResults');
    container.innerHTML = '';
    for (let i = 1; i <= semester; i++) {
        const semSubjects = student?.semesters?.[i]?.subjects || [];
        const div = document.createElement('div');
        div.className = 'mb-6';
        div.id = `semester-${i}`;
        div.innerHTML = `
            <h3 class="text-lg font-bold text-white mb-3">Semester ${i}</h3>
            <div id="semester-${i}-subjects" class="space-y-2">
                ${semSubjects.map(s => `
                    <div class="flex space-x-2 subject-row">
                        <input type="text" value="${s.name}" class="px-4 py-3 bg-blue-900/50 border border-blue-600 rounded-lg subject-name focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" readonly>
                        <input type="number" value="${s.marks}" min="0" max="100" class="px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg subject-marks focus:ring-2 focus:ring-green-500 focus:border-green-500 text-white" required>
                    </div>
                `).join('')}
            </div>
        `;
        container.appendChild(div);
    }
}

// Close modal
function closeModal() {
    document.getElementById('studentModal').classList.add('hidden');
}

// Edit/delete student
function editStudent(rollNo) {
    const student = students.find(s => s.rollNo === rollNo);
    if (student) {
        editingStudent = student;
        document.getElementById('modalTitle').textContent = 'Edit Student';
        document.getElementById('modalRollNo').value = student.rollNo;
        document.getElementById('modalStudentName').value = student.name;
        document.getElementById('modalPassword').value = student.password;
        document.getElementById('modalParentPhone').value = student.parentPhone;
        document.getElementById('modalProgram').value = student.program;
        document.getElementById('modalCourse').value = student.course;
        document.getElementById('modalSemester').value = student.currentSemester;
        generateSemesterInputs(student.currentSemester, student);
        document.getElementById('studentModal').classList.remove('hidden');
    }
}

function deleteStudent(rollNo) {
    if (confirm('Are you sure you want to delete this student?')) {
        students = students.filter(s => s.rollNo !== rollNo);
        displayAllStudents();
        updateAdminStats();
        syncToFirebase();
    }
}

// Display all students
function displayAllStudents() {
    const tbody = document.getElementById('studentsTable');
    tbody.innerHTML = students.map(student => {
        const cgpa = calculateCGPA(student);
        const backlogs = calculateBacklogs(student).length;
        const attPercent = calculateAttendancePercentage(student);
        return `
            <tr class="border-t border-gray-700">
                <td class="px-6 py-4 text-sm text-gray-300">${student.rollNo}</td>
                <td class="px-6 py-4 text-sm text-white">${student.name}</td>
                <td class="px-6 py-4 text-sm text-green-400">${cgpa}</td>
                <td class="px-6 py-4 text-sm ${attPercent < 70 ? 'text-red-400' : 'text-green-400'}">${attPercent}%</td>
                <td class="px-6 py-4 text-sm ${backlogs > 0 ? 'text-red-400' : 'text-green-400'}">${backlogs}</td>
                <td class="px-6 py-4 text-sm">
                    <button onclick="editStudent('${student.rollNo}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs mr-2">Edit</button>
                    <button onclick="deleteStudent('${student.rollNo}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

// Show backlog students
function showBacklogStudents() {
    const container = document.getElementById('backlogStudentsList');
    const backlogStudents = students.filter(s => calculateBacklogs(s).length > 0);
    container.innerHTML = backlogStudents.map(student => {
        const backlogs = calculateBacklogs(student);
        return `
            <div class="bg-gradient-to-r from-red-900/30 to-red-800/30 border border-red-700 rounded-xl p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-white">${student.name}</h3>
                        <p class="text-gray-300">Roll No: ${student.rollNo}</p>
                        <p class="text-gray-300">CGPA: ${calculateCGPA(student)}</p>
                        <p class="text-gray-300">üìû ${student.parentPhone}</p>
                    </div>
                    <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium">${backlogs.length} Backlog${backlogs.length > 1 ? 's' : ''}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${backlogs.map(b => `<div class="dark-card p-4 rounded-lg shadow-md border-l-4 border-red-500"><p class="font-semibold text-white">Semester ${b.semester}</p><p class="text-gray-300 text-sm">${b.subject}</p><p class="text-red-400 font-bold">${b.marks} marks</p></div>`).join('')}
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('studentsTab').classList.add('hidden');
    document.getElementById('backlogDetailsSection').classList.remove('hidden');
}

function showAllStudents() {
    document.getElementById('backlogDetailsSection').classList.add('hidden');
    document.getElementById('studentsTab').classList.remove('hidden');
    displayAllStudents();
}

// Update admin stats
function updateAdminStats() {
    const total = students.length;
    const passCount = students.filter(s => calculateBacklogs(s).length === 0).length;
    const backlogCount = students.filter(s => calculateBacklogs(s).length > 0).length;
    const lowAttCount = students.filter(s => calculateAttendancePercentage(s) < 70).length;
    const passRate = total > 0 ? Math.round((passCount / total) * 100) : 0;

    document.getElementById('totalStudents').textContent = total;
    document.getElementById('passRate').textContent = `${passRate}%`;
    document.getElementById('backlogCount').textContent = backlogCount;
    document.getElementById('lowAttendanceCount').textContent = lowAttCount;
}

// Attendance tab
function loadAttendanceStudents() {
    const date = document.getElementById('attendanceDate').value;
    const program = document.getElementById('attendanceProgram').value;
    const course = document.getElementById('attendanceCourse').value;
    const semester = document.getElementById('attendanceSemester').value;
    const subject = document.getElementById('attendanceSubject').value;

    if (!date || !program || !course || !semester || !subject) {
        alert('Please fill all fields');
        return;
    }

    const filtered = students.filter(s => 
        s.program === program && s.course === course && s.currentSemester == semester
    );

    const container = document.getElementById('attendanceStudentsList');
    container.innerHTML = `
        <h3 class="text-xl font-bold text-white mb-4">Mark Attendance - ${subject} (${date})</h3>
        <div class="space-y-4">
            ${filtered.map(student => {
                const currentStatus = student.attendance?.[subject]?.[date] || '';
                return `
                    <div class="dark-card p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <h4 class="text-white font-semibold">${student.name}</h4>
                            <p class="text-gray-400 text-sm">${student.rollNo}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="markAttendance('${student.rollNo}', '${subject}', '${date}', 'present')"
                                    class="px-4 py-2 rounded-lg font-medium transition-all ${currentStatus === 'present' ? 'attendance-present text-white' : 'bg-gray-700 text-gray-300 hover:bg-green-600 hover:text-white'}">Present</button>
                            <button onclick="markAttendance('${student.rollNo}', '${subject}', '${date}', 'absent')"
                                    class="px-4 py-2 rounded-lg font-medium transition-all ${currentStatus === 'absent' ? 'attendance-absent text-white' : 'bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white'}">Absent</button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        <div class="mt-6 text-center">
            <button onclick="saveAttendance()" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-8 py-3 rounded-xl hover:from-green-700 hover:to-green-800 transition-all shadow-lg font-medium">Save Attendance</button>
        </div>
    `;
}

function markAttendance(rollNo, subject, date, status) {
    const student = students.find(s => s.rollNo === rollNo);
    if (!student.attendance) student.attendance = {};
    if (!student.attendance[subject]) student.attendance[subject] = {};
    student.attendance[subject][date] = status;
    loadAttendanceStudents(); // Refresh UI
}

function saveAttendance() {
    alert('Attendance saved successfully!');
    updateAdminStats();
    syncToFirebase();
    checkAndSendNotifications();
}

// Notifications tab
function displayNotifications() {
    // This will be populated by Firebase later
}

// Login
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('authError');

    if (document.getElementById('studentTypeTab').classList.contains('bg-green-600')) {
        const rollNo = document.getElementById('rollNo').value;
        const student = students.find(s => s.rollNo === rollNo && s.password === password);
        if (student) {
            currentUser = student;
            isAdmin = false;
            showStudentDashboard();
        } else {
            showError('Invalid roll number or password');
        }
    } else {
        const username = document.getElementById('username').value;
        const admin = admins.find(a => a.username === username && a.password === password);
        if (admin) {
            currentUser = admin;
            isAdmin = true;
            showAdminDashboard();
            await loadStudentsFromFirebase();
        } else {
            showError('Invalid admin credentials');
        }
    }
});

function showError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}

function showStudentDashboard() {
    document.getElementById('authPage').classList.add('hidden');
    document.getElementById('studentDashboard').classList.remove('hidden');
    document.getElementById('studentName').textContent = `${currentUser.name} (${currentUser.rollNo})`;
    displayStudentResults();
    displayStudentAttendance();
}

function showAdminDashboard() {
    document.getElementById('authPage').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    updateAdminStats();
    showAllStudents();
    checkAndSendNotifications();
}

function logout() {
    currentUser = null;
    isAdmin = false;
    document.getElementById('authPage').classList.remove('hidden');
    document.getElementById('studentDashboard').classList.add('hidden');
    document.getElementById('adminDashboard').classList.add('hidden');
}

// Initial setup
document.getElementById('attendanceProgram').addEventListener('change', updateAttendanceSubjects);
document.getElementById('attendanceCourse').addEventListener('change', updateAttendanceSubjects);
document.getElementById('attendanceSemester').addEventListener('change', updateAttendanceSubjects);

function updateAttendanceSubjects() {
    const program = document.getElementById('attendanceProgram').value;
    const course = document.getElementById('attendanceCourse').value;
    const semester = document.getElementById('attendanceSemester').value;
    const select = document.getElementById('attendanceSubject');
    
    if (program && course && semester) {
        const subjects = curriculumTemplates[program]?.[course]?.[semester] || [];
        select.innerHTML = '<option value="">Select Subject</option>';
        subjects.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            select.appendChild(opt);
        });
    } else {
        select.innerHTML = '<option value="">Select Subject</option>';
    }
}

// On page load
updateAttendanceSubjects();
</script>

</body>
</html>
